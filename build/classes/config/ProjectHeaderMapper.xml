<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ProjectHeaderMapper">

  <resultMap id="ProjectHeaderMap" type="com.oopsw.model.vo.ProjectHeaderVO">
    <result property="projectName" column="project_name"/>
    <result property="startDate"   column="start_date"/>
    <result property="endDate"     column="end_date"/>
    <result property="description" column="description"/>
    <result property="membersCnt"  column="members_cnt"/>
    <result property="workingCnt"  column="working_cnt"/>
  </resultMap>

  <select id="selectProjectHeader" resultMap="ProjectHeaderMap">
    SELECT 
      p.project_name, p.start_date, p.end_date, p.description,
      COUNT(DISTINCT pj.employee_id) AS members_cnt,
      COUNT(DISTINCT CASE WHEN e.work_status != '퇴근' THEN pj.employee_id END) AS working_cnt
    FROM projects p
    LEFT JOIN project_join pj ON p.project_no = pj.project_no AND pj.join_flag = 1
    LEFT JOIN employees e     ON pj.employee_id = e.employee_id
    WHERE p.project_no = #{projectNo}
    GROUP BY p.project_name, p.start_date, p.end_date, p.description
  </select>
</mapper>
