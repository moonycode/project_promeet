<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ProjectMembersMapper">

  <resultMap id="ProjectJoinViewMap" type="com.oopsw.model.vo.ProjectJoinVO">
    <result property="employeeId" column="employee_id"/>
    <result property="name" column="name"/>
    <result property="position" column="position"/>
    <result property="department" column="department"/>
    <result property="phoneNumber" column="phone_number"/>
    <result property="email" column="email"/>
    <result property="managerId" column="manager_id"/>
    <result property="projectNo" column="project_no"/>
    <result property="projectJoinNo" column="project_join_no"/>
    <result property="inDate" column="in_date"/>
    <result property="upDate" column="up_date"/>
    <result property="joinFlag" column="join_flag"/>
  </resultMap>

  <!-- 전체 직원 리스트(퇴사 제외) + 팀장 우선 + 부서/이름 정렬 -->
  <select id="selectAllEmployeesForProjectOrdered" resultMap="ProjectJoinViewMap">
    SELECT
      e.employee_id, e.name, e.position, e.department,
      e.phone_number, e.email,
      p.manager_id,
      #{projectNo} AS project_no,
      pj.project_join_no,
      pj.in_date, pj.up_date,
      NVL(pj.join_flag, 0) AS join_flag
    FROM employees e
    LEFT JOIN project_join pj
      ON e.employee_id = pj.employee_id
     AND pj.project_no = #{projectNo}
    JOIN projects p
      ON p.project_no = #{projectNo}
    WHERE e.resign_date IS NULL
    ORDER BY
      CASE WHEN e.employee_id = p.manager_id THEN 0 ELSE 1 END,
      e.department ASC,
      e.name ASC
  </select>

  <!-- 프로젝트 참여 중(퇴사 제외) -->
  <select id="selectJoinedMembers" resultMap="ProjectJoinViewMap">
    SELECT
      e.employee_id, e.name, e.position, e.department,
      e.phone_number, e.email,
      p.manager_id,
      pj.project_no,
      pj.project_join_no,
      pj.in_date, pj.up_date,
      NVL(pj.join_flag, 0) AS join_flag
    FROM project_join pj
    JOIN employees e ON pj.employee_id = e.employee_id
    JOIN projects  p ON pj.project_no  = p.project_no
    WHERE pj.project_no = #{projectNo}
      AND pj.join_flag  = 1
      AND e.resign_date IS NULL
  </select>

  <!-- project_join on/off/insert -->
  <insert id="insertProjectMember" parameterType="com.oopsw.model.vo.ProjectJoinVO">
    INSERT INTO project_join (project_join_no, employee_id, project_no, in_date, up_date, join_flag)
    VALUES (project_join_seq.NEXTVAL, #{employeeId}, #{projectNo}, SYSDATE, NULL, 1)
  </insert>

  <update id="softRemoveProjectMember">
    UPDATE project_join
       SET join_flag = 0, up_date = SYSDATE
     WHERE project_no = #{projectNo}
       AND employee_id = #{employeeId}
       AND join_flag = 1
  </update>

  <update id="readdProjectMember">
    UPDATE project_join
       SET join_flag = 1, up_date = SYSDATE
     WHERE project_no = #{projectNo}
       AND employee_id = #{employeeId}
       AND join_flag = 0
  </update>
</mapper>
